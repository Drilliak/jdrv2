{% extends "JDRCoreBundle::layout.html.twig" %}

{% block title %}Édition de la partie {% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/jquery-ui.min.css') }}" rel="stylesheet"/>
    <link href="{{ asset('css/bootstrap-taginput/bootstrap-tagsinput.css') }}" rel="stylesheet"/>
{% endblock %}

{% block body %}
    <h2>Partie {{ name }}</h2>

    <h3>Caractéristiques autorisées</h3>
    {% set actualStats = '' %}
    {% for allowedStat in allowedStats %}
        {% set actualStats = actualStats ~ allowedStat ~ ',' %}
    {% endfor %}
    <input type="text" data-role="tagsinput" value="{{ actualStats }}"/>


    <h3>Participants</h3>
    <ul id="participants">
        {% for invitation in invitations %}
            {% if invitation.statut == "wait" %}
                {% set msg = '<li id="' ~  invitation.username  ~ '"> ' ~ invitation.username  ~ ' En attente <button class="cancelinvitation">Annuler l\'invitation</button></li>' %}
            {% endif %}
            {% if invitation.statut == "accepted" %}
                {% set msg = '<li id="' ~  invitation.username  ~ '"> ' ~ invitation.username  ~ ' <button class="removePlayer">Retirer le joueur</button></li>' %}
            {% endif %}
            {% if invitation.statut == "denied" %}
                {% set msg = '<li id="' ~  invitation.username  ~ '"> ' ~ invitation.username  ~ ' Refusé <button class="sendagain">Renvoyer l\'invitation</button><span class="ui-icon ui-icon-close"></span></li>' %}
            {% endif %}
            {{ msg|raw }}
        {% endfor %}
    </ul>


    <label for="users">Ajouter un joueur : </label><input type="text" id="users" name="_users"/>

    <button id="opener">Supprimer la partie</button>
    <div id="error"></div>

    {# Contenu de la fenêtre popup #}
    <div id="dialog" title="Suppression de la partie">
        Êtes-vous sûr(e) de vouloir supprimer la partie ? Cette action sera définitive.
    </div>

{% endblock %}
    {% block javascript %}
        {{ parent() }}
        <script src="{{ asset('js/jquery-ui.min.js') }}"></script>
        <script src="{{ asset('js/bootstrap-taginput/bootstrap-tagsinput.js') }}"></script>
        <script>

            function removeSession() {
                $("#dialog").dialog({
                    autoOpen: false,
                    modal: true,
                    buttons: [
                        {
                            text: "Oui",
                            click: function () {
                                $(location).attr('href', "{{ path('jdr_core_session_destroy', {'id': id}) }}");
                            }
                        },
                        {
                            text: 'Non',
                            click: function () {
                                $(this).dialog('close');
                            }
                        }
                    ]
                });
                $("#opener").click(function () {
                    $("#dialog").dialog("open");
                });
            }


            function addItem(event) {
                $.post(
                    "{{ path('jdr_core_ajax_add_stat_session') }}",
                    {
                        stat: event.item,
                        idSession: {{ id }}
                    },
                    function (data) {

                    },
                    'json'
                );

            }

            function removeItem(event) {
                $.post(
                    "{{ path('jdr_core_ajax_remove_stat_session') }}",
                    {
                        stat: event.item,
                        idSession: {{ id }}
                    },
                    function (data) {

                    },
                    'json'
                );
            }

            function sendInvit(ui) {
                $.post(
                    "{{ path('jdr_core_ajax_send_invitation') }}",
                    {
                        idSession: {{ id }},
                        playerName: ui.item.value
                    },
                    function (data) {
                    },
                    'json'
                );
            }

            // Fonctions pour la gestion des invitations

            function

        </script>

        <script>
            $(document).ready(function () {
                $('input').on('itemAdded', function (event) {
                    addItem(event);
                });
                $('input').on('itemRemoved', function (event) {
                    removeItem(event);
                });
                $("#users").autocomplete({
                    source: "{{ path('jdr_core_ajax_username') }}",

                    select: function (event, ui) {
                        if (!$("#" + ui.item.value).length) {
                            $("#participants").append('<li id="ui.item.value">' + ui.item.value + ' En attente <button class="cancelinvitation">Annuler l\'invitation</button></li>');
                            sendInvit(ui);
                        } else {
                            $("#error").html('<p>Une invitation a déjà été envoyée à ce joueur</p>');
                            $("#error").show();
                            setTimeout(function () {
                                $("#error").hide(1000);
                                $("#error").val('');
                            }, 5000);
                        }

                        ui.item.value = "";
                    }
                });

                removeSession();
            });
        </script>
    {% endblock %}